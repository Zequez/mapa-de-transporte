/**
 * @license
 * jQuery Cookie Plugin
 * https://github.com/carhartl/jquery-cookie
 *
 * Copyright 2011, Klaus Hartl
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.opensource.org/licenses/GPL-2.0
 */
function InfoBox(a){a=a||{},google.maps.OverlayView.apply(this,arguments),this.content_=a.content||"",this.disableAutoPan_=a.disableAutoPan||!1,this.maxWidth_=a.maxWidth||0,this.pixelOffset_=a.pixelOffset||new google.maps.Size(0,0),this.position_=a.position||new google.maps.LatLng(0,0),this.zIndex_=a.zIndex||null,this.boxClass_=a.boxClass||"infoBox",this.boxStyle_=a.boxStyle||{},this.closeBoxMargin_=a.closeBoxMargin||"2px",this.closeBoxURL_=a.closeBoxURL||"http://www.google.com/intl/en_us/mapfiles/close.gif",a.closeBoxURL===""&&(this.closeBoxURL_=""),this.infoBoxClearance_=a.infoBoxClearance||new google.maps.Size(1,1),this.isHidden_=a.isHidden||!1,this.alignBottom_=a.alignBottom||!1,this.pane_=a.pane||"floatPane",this.enableEventPropagation_=a.enableEventPropagation||!1,this.div_=null,this.closeListener_=null,this.moveListener_=null,this.contextListener_=null,this.eventListeners_=null,this.fixedWidthSet_=null}(function(a){a.cookie=function(b,c,d){if(arguments.length>1&&(!/Object/.test(Object.prototype.toString.call(c))||c===null||c===undefined)){d=a.extend({},d);if(c===null||c===undefined)d.expires=-1;if(typeof d.expires=="number"){var e=d.expires,f=d.expires=new Date;f.setDate(f.getDate()+e)}return c=String(c),document.cookie=[encodeURIComponent(b),"=",d.raw?c:encodeURIComponent(c),d.expires?"; expires="+d.expires.toUTCString():"",d.path?"; path="+d.path:"",d.domain?"; domain="+d.domain:"",d.secure?"; secure":""].join("")}d=c||{};var g=d.raw?function(a){return a}:decodeURIComponent,h=document.cookie.split("; ");for(var i=0,j;j=h[i]&&h[i].split("=");i++)if(g(j[0])===b)return g(j[1]||"");return null}})(jQuery),function(a,b){function m(b,c,d,e){var h={data:e||e===0||e===!1?e:c?c.data:{},_wrap:c?c._wrap:null,tmpl:null,parent:c||null,nodes:[],calls:u,nest:v,wrap:w,html:x,update:y};return b&&a.extend(h,b,{nodes:[],parent:c}),d&&(h.tmpl=d,h._ctnt=h._ctnt||h.tmpl(a,h),h.key=++j,(l.length?g:f)[j]=h),h}function n(b,c,e){var f,g=e?a.map(e,function(a){return typeof a=="string"?b.key?a.replace(/(<\w+)(?=[\s>])(?![^>]*_tmplitem)([^>]*)/g,"$1 "+d+'="'+b.key+'" $2'):a:n(a,b,a._ctnt)}):b;return c?g:(g=g.join(""),g.replace(/^\s*([^<\s][^<]*)?(<[\w\W]+>)([^>]*[^>\s])?\s*$/,function(b,c,d,e){f=a(d).get(),t(f),c&&(f=o(c).concat(f)),e&&(f=f.concat(o(e)))}),f?f:o(g))}function o(b){var c=document.createElement("div");return c.innerHTML=b,a.makeArray(c.childNodes)}function p(b){return new Function("jQuery","$item","var $=jQuery,call,__=[],$data=$item.data;with($data){__.push('"+a.trim(b).replace(/([\\'])/g,"\\$1").replace(/[\r\t\n]/g," ").replace(/\$\{([^\}]*)\}/g,"{{= $1}}").replace(/\{\{(\/?)(\w+|.)(?:\(((?:[^\}]|\}(?!\}))*?)?\))?(?:\s+(.*?)?)?(\(((?:[^\}]|\}(?!\}))*?)\))?\s*\}\}/g,function(b,c,d,e,f,g,h){var i=a.tmpl.tag[d],j,k,l;if(!i)throw"Unknown template tag: "+d;return j=i._default||[],g&&!/\w$/.test(f)&&(f+=g,g=""),f?(f=r(f),h=h?","+r(h)+")":g?")":"",k=g?f.indexOf(".")>-1?f+r(g):"("+f+").call($item"+h:f,l=g?k:"(typeof("+f+")==='function'?("+f+").call($item):("+f+"))"):l=k=j.$1||"null",e=r(e),"');"+i[c?"close":"open"].split("$notnull_1").join(f?"typeof("+f+")!=='undefined' && ("+f+")!=null":"true").split("$1a").join(l).split("$1").join(k).split("$2").join(e||j.$2||"")+"__.push('"})+"');}return __;")}function q(b,c){b._wrap=n(b,!0,a.isArray(c)?c:[e.test(c)?c:a(c).html()]).join("")}function r(a){return a?a.replace(/\\'/g,"'").replace(/\\\\/g,"\\"):null}function s(a){var b=document.createElement("div");return b.appendChild(a.cloneNode(!0)),b.innerHTML}function t(b){function p(b){function p(a){a+=c,n=i[a]=i[a]||m(n,f[n.parent.key+c]||n.parent)}var e,h=b,l,n,o;if(o=b.getAttribute(d)){while(h.parentNode&&(h=h.parentNode).nodeType===1&&!(e=h.getAttribute(d)));e!==o&&(h=h.parentNode?h.nodeType===11?0:h.getAttribute(d)||0:0,(n=f[o])||(n=g[o],n=m(n,f[h]||g[h]),n.key=++j,f[j]=n),k&&p(o)),b.removeAttribute(d)}else k&&(n=a.data(b,"tmplItem"))&&(p(n.key),f[n.key]=n,h=a.data(b.parentNode,"tmplItem"),h=h?h.key:0);if(n){l=n;while(l&&l.key!=h)l.nodes.push(b),l=l.parent;delete n._ctnt,delete n._wrap,a.data(b,"tmplItem",n)}}var c="_"+k,e,h,i={},l,n,o;for(l=0,n=b.length;l<n;l++){if((e=b[l]).nodeType!==1)continue;h=e.getElementsByTagName("*");for(o=h.length-1;o>=0;o--)p(h[o]);p(e)}}function u(a,b,c,d){if(!a)return l.pop();l.push({_:a,tmpl:b,item:this,data:c,options:d})}function v(b,c,d){return a.tmpl(a.template(b),c,d,this)}function w(b,c){var d=b.options||{};return d.wrapped=c,a.tmpl(a.template(b.tmpl),b.data,d,b.item)}function x(b,c){var d=this._wrap;return a.map(a(a.isArray(d)?d.join(""):d).filter(b||"*"),function(a){return c?a.innerText||a.textContent:a.outerHTML||s(a)})}function y(){var b=this.nodes;a.tmpl(null,null,null,this).insertBefore(b[0]),a(b).remove()}var c=a.fn.domManip,d="_tmplitem",e=/^[^<]*(<[\w\W]+>)[^>]*$|\{\{\! /,f={},g={},h,i={key:0,data:{}},j=0,k=0,l=[];a.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(b,c){a.fn[b]=function(d){var e=[],g=a(d),i,j,l,m,n=this.length===1&&this[0].parentNode;h=f||{};if(n&&n.nodeType===11&&n.childNodes.length===1&&g.length===1)g[c](this[0]),e=this;else{for(j=0,l=g.length;j<l;j++)k=j,i=(j>0?this.clone(!0):this).get(),a(g[j])[c](i),e=e.concat(i);k=0,e=this.pushStack(e,b,g.selector)}return m=h,h=null,a.tmpl.complete(m),e}}),a.fn.extend({tmpl:function(b,c,d){return a.tmpl(this[0],b,c,d)},tmplItem:function(){return a.tmplItem(this[0])},template:function(b){return a.template(b,this[0])},domManip:function(b,d,e,g){if(b[0]&&a.isArray(b[0])){var i=a.makeArray(arguments),j=b[0],l=j.length,m=0,n;while(m<l&&!(n=a.data(j[m++],"tmplItem")));n&&k&&(i[2]=function(b){a.tmpl.afterManip(this,b,e)}),c.apply(this,i)}else c.apply(this,arguments);return k=0,h||a.tmpl.complete(f),this}}),a.extend({tmpl:function(b,c,d,e){var h,j=!e;if(j)e=i,b=a.template[b]||a.template(null,b),g={};else if(!b)return b=e.tmpl,f[e.key]=e,e.nodes=[],e.wrapped&&q(e,e.wrapped),a(n(e,null,e.tmpl(a,e)));return b?(typeof c=="function"&&(c=c.call(e||{})),d&&d.wrapped&&q(d,d.wrapped),h=a.isArray(c)?a.map(c,function(a){return a?m(d,e,b,a):null}):[m(d,e,b,c)],j?a(n(e,null,h)):h):[]},tmplItem:function(b){var c;b instanceof a&&(b=b[0]);while(b&&b.nodeType===1&&!(c=a.data(b,"tmplItem"))&&(b=b.parentNode));return c||i},template:function(b,c){return c?(typeof c=="string"?c=p(c):c instanceof a&&(c=c[0]||{}),c.nodeType&&(c=a.data(c,"tmpl")||a.data(c,"tmpl",p(c.innerHTML))),typeof b=="string"?a.template[b]=c:c):b?typeof b!="string"?a.template(null,b):a.template[b]||a.template(null,e.test(b)?b:a(b)):null},encode:function(a){return(""+a).split("<").join("&lt;").split(">").join("&gt;").split('"').join("&#34;").split("'").join("&#39;")}}),a.extend(a.tmpl,{tag:{tmpl:{_default:{$2:"null"},open:"if($notnull_1){__=__.concat($item.nest($1,$2));}"},wrap:{_default:{$2:"null"},open:"$item.calls(__,$1,$2);__=[];",close:"call=$item.calls();__=call._.concat($item.wrap(call,__));"},each:{_default:{$2:"$index, $value"},open:"if($notnull_1){$.each($1a,function($2){with(this){",close:"}});}"},"if":{open:"if(($notnull_1) && $1a){",close:"}"},"else":{_default:{$1:"true"},open:"}else if(($notnull_1) && $1a){"},html:{open:"if($notnull_1){__.push($1a);}"},"=":{_default:{$1:"$data"},open:"if($notnull_1){__.push($.encode($1a));}"},"!":{open:""}},complete:function(a){f={}},afterManip:function(c,d,e){var f=d.nodeType===11?a.makeArray(d.childNodes):d.nodeType===1?[d]:[];e.call(c,d),t(f),k++}})}(jQuery),function(){function A(a,b,c){if(a===b)return a!==0||1/a==1/b;if(a==null||b==null)return a===b;a._chain&&(a=a._wrapped),b._chain&&(b=b._wrapped);if(a.isEqual&&w.isFunction(a.isEqual))return a.isEqual(b);if(b.isEqual&&w.isFunction(b.isEqual))return b.isEqual(a);var d=i.call(a);if(d!=i.call(b))return!1;switch(d){case"[object String]":return a==String(b);case"[object Number]":return a!=+a?b!=+b:a==0?1/a==1/b:a==+b;case"[object Date]":case"[object Boolean]":return+a==+b;case"[object RegExp]":return a.source==b.source&&a.global==b.global&&a.multiline==b.multiline&&a.ignoreCase==b.ignoreCase}if(typeof a!="object"||typeof b!="object")return!1;var e=c.length;while(e--)if(c[e]==a)return!0;c.push(a);var f=0,g=!0;if(d=="[object Array]"){f=a.length,g=f==b.length;if(g)while(f--)if(!(g=f in a==f in b&&A(a[f],b[f],c)))break}else{if("constructor"in a!="constructor"in b||a.constructor!=b.constructor)return!1;for(var h in a)if(w.has(a,h)){f++;if(!(g=w.has(b,h)&&A(a[h],b[h],c)))break}if(g){for(h in b)if(w.has(b,h)&&!(f--))break;g=!f}}return c.pop(),g}var a=this,b=a._,c={},d=Array.prototype,e=Object.prototype,f=Function.prototype,g=d.slice,h=d.unshift,i=e.toString,j=e.hasOwnProperty,k=d.forEach,l=d.map,m=d.reduce,n=d.reduceRight,o=d.filter,p=d.every,q=d.some,r=d.indexOf,s=d.lastIndexOf,t=Array.isArray,u=Object.keys,v=f.bind,w=function(a){return new I(a)};typeof exports!="undefined"?(typeof module!="undefined"&&module.exports&&(exports=module.exports=w),exports._=w):a._=w,w.VERSION="1.3.3";var x=w.each=w.forEach=function(a,b,d){if(a==null)return;if(k&&a.forEach===k)a.forEach(b,d);else if(a.length===+a.length){for(var e=0,f=a.length;e<f;e++)if(e in a&&b.call(d,a[e],e,a)===c)return}else for(var g in a)if(w.has(a,g)&&b.call(d,a[g],g,a)===c)return};w.map=w.collect=function(a,b,c){var d=[];return a==null?d:l&&a.map===l?a.map(b,c):(x(a,function(a,e,f){d[d.length]=b.call(c,a,e,f)}),a.length===+a.length&&(d.length=a.length),d)},w.reduce=w.foldl=w.inject=function(a,b,c,d){var e=arguments.length>2;a==null&&(a=[]);if(m&&a.reduce===m)return d&&(b=w.bind(b,d)),e?a.reduce(b,c):a.reduce(b);x(a,function(a,f,g){e?c=b.call(d,c,a,f,g):(c=a,e=!0)});if(!e)throw new TypeError("Reduce of empty array with no initial value");return c},w.reduceRight=w.foldr=function(a,b,c,d){var e=arguments.length>2;a==null&&(a=[]);if(n&&a.reduceRight===n)return d&&(b=w.bind(b,d)),e?a.reduceRight(b,c):a.reduceRight(b);var f=w.toArray(a).reverse();return d&&!e&&(b=w.bind(b,d)),e?w.reduce(f,b,c,d):w.reduce(f,b)},w.find=w.detect=function(a,b,c){var d;return y(a,function(a,e,f){if(b.call(c,a,e,f))return d=a,!0}),d},w.filter=w.select=function(a,b,c){var d=[];return a==null?d:o&&a.filter===o?a.filter(b,c):(x(a,function(a,e,f){b.call(c,a,e,f)&&(d[d.length]=a)}),d)},w.reject=function(a,b,c){var d=[];return a==null?d:(x(a,function(a,e,f){b.call(c,a,e,f)||(d[d.length]=a)}),d)},w.every=w.all=function(a,b,d){var e=!0;return a==null?e:p&&a.every===p?a.every(b,d):(x(a,function(a,f,g){if(!(e=e&&b.call(d,a,f,g)))return c}),!!e)};var y=w.some=w.any=function(a,b,d){b||(b=w.identity);var e=!1;return a==null?e:q&&a.some===q?a.some(b,d):(x(a,function(a,f,g){if(e||(e=b.call(d,a,f,g)))return c}),!!e)};w.include=w.contains=function(a,b){var c=!1;return a==null?c:r&&a.indexOf===r?a.indexOf(b)!=-1:(c=y(a,function(a){return a===b}),c)},w.invoke=function(a,b){var c=g.call(arguments,2);return w.map(a,function(a){return(w.isFunction(b)?b||a:a[b]).apply(a,c)})},w.pluck=function(a,b){return w.map(a,function(a){return a[b]})},w.max=function(a,b,c){if(!b&&w.isArray(a)&&a[0]===+a[0])return Math.max.apply(Math,a);if(!b&&w.isEmpty(a))return-Infinity;var d={computed:-Infinity};return x(a,function(a,e,f){var g=b?b.call(c,a,e,f):a;g>=d.computed&&(d={value:a,computed:g})}),d.value},w.min=function(a,b,c){if(!b&&w.isArray(a)&&a[0]===+a[0])return Math.min.apply(Math,a);if(!b&&w.isEmpty(a))return Infinity;var d={computed:Infinity};return x(a,function(a,e,f){var g=b?b.call(c,a,e,f):a;g<d.computed&&(d={value:a,computed:g})}),d.value},w.shuffle=function(a){var b=[],c;return x(a,function(a,d,e){c=Math.floor(Math.random()*(d+1)),b[d]=b[c],b[c]=a}),b},w.sortBy=function(a,b,c){var d=w.isFunction(b)?b:function(a){return a[b]};return w.pluck(w.map(a,function(a,b,e){return{value:a,criteria:d.call(c,a,b,e)}}).sort(function(a,b){var c=a.criteria,d=b.criteria;return c===void 0?1:d===void 0?-1:c<d?-1:c>d?1:0}),"value")},w.groupBy=function(a,b){var c={},d=w.isFunction(b)?b:function(a){return a[b]};return x(a,function(a,b){var e=d(a,b);(c[e]||(c[e]=[])).push(a)}),c},w.sortedIndex=function(a,b,c){c||(c=w.identity);var d=0,e=a.length;while(d<e){var f=d+e>>1;c(a[f])<c(b)?d=f+1:e=f}return d},w.toArray=function(a){return a?w.isArray(a)?g.call(a):w.isArguments(a)?g.call(a):a.toArray&&w.isFunction(a.toArray)?a.toArray():w.values(a):[]},w.size=function(a){return w.isArray(a)?a.length:w.keys(a).length},w.first=w.head=w.take=function(a,b,c){return b!=null&&!c?g.call(a,0,b):a[0]},w.initial=function(a,b,c){return g.call(a,0,a.length-(b==null||c?1:b))},w.last=function(a,b,c){return b!=null&&!c?g.call(a,Math.max(a.length-b,0)):a[a.length-1]},w.rest=w.tail=function(a,b,c){return g.call(a,b==null||c?1:b)},w.compact=function(a){return w.filter(a,function(a){return!!a})},w.flatten=function(a,b){return w.reduce(a,function(a,c){return w.isArray(c)?a.concat(b?c:w.flatten(c)):(a[a.length]=c,a)},[])},w.without=function(a){return w.difference(a,g.call(arguments,1))},w.uniq=w.unique=function(a,b,c){var d=c?w.map(a,c):a,e=[];return a.length<3&&(b=!0),w.reduce(d,function(c,d,f){if(b?w.last(c)!==d||!c.length:!w.include(c,d))c.push(d),e.push(a[f]);return c},[]),e},w.union=function(){return w.uniq(w.flatten(arguments,!0))},w.intersection=w.intersect=function(a){var b=g.call(arguments,1);return w.filter(w.uniq(a),function(a){return w.every(b,function(b){return w.indexOf(b,a)>=0})})},w.difference=function(a){var b=w.flatten(g.call(arguments,1),!0);return w.filter(a,function(a){return!w.include(b,a)})},w.zip=function(){var a=g.call(arguments),b=w.max(w.pluck(a,"length")),c=new Array(b);for(var d=0;d<b;d++)c[d]=w.pluck(a,""+d);return c},w.indexOf=function(a,b,c){if(a==null)return-1;var d,e;if(c)return d=w.sortedIndex(a,b),a[d]===b?d:-1;if(r&&a.indexOf===r)return a.indexOf(b);for(d=0,e=a.length;d<e;d++)if(d in a&&a[d]===b)return d;return-1},w.lastIndexOf=function(a,b){if(a==null)return-1;if(s&&a.lastIndexOf===s)return a.lastIndexOf(b);var c=a.length;while(c--)if(c in a&&a[c]===b)return c;return-1},w.range=function(a,b,c){arguments.length<=1&&(b=a||0,a=0),c=arguments[2]||1;var d=Math.max(Math.ceil((b-a)/c),0),e=0,f=new Array(d);while(e<d)f[e++]=a,a+=c;return f};var z=function(){};w.bind=function(b,c){var d,e;if(b.bind===v&&v)return v.apply(b,g.call(arguments,1));if(!w.isFunction(b))throw new TypeError;return e=g.call(arguments,2),d=function(){if(this instanceof d){z.prototype=b.prototype;var a=new z,f=b.apply(a,e.concat(g.call(arguments)));return Object(f)===f?f:a}return b.apply(c,e.concat(g.call(arguments)))}},w.bindAll=function(a){var b=g.call(arguments,1);return b.length==0&&(b=w.functions(a)),x(b,function(b){a[b]=w.bind(a[b],a)}),a},w.memoize=function(a,b){var c={};return b||(b=w.identity),function(){var d=b.apply(this,arguments);return w.has(c,d)?c[d]:c[d]=a.apply(this,arguments)}},w.delay=function(a,b){var c=g.call(arguments,2);return setTimeout(function(){return a.apply(null,c)},b)},w.defer=function(a){return w.delay.apply(w,[a,1].concat(g.call(arguments,1)))},w.throttle=function(a,b){var c,d,e,f,g,h,i=w.debounce(function(){g=f=!1},b);return function(){c=this,d=arguments;var j=function(){e=null,g&&a.apply(c,d),i()};return e||(e=setTimeout(j,b)),f?g=!0:h=a.apply(c,d),i(),f=!0,h}},w.debounce=function(a,b,c){var d;return function(){var e=this,f=arguments,g=function(){d=null,c||a.apply(e,f)};c&&!d&&a.apply(e,f),clearTimeout(d),d=setTimeout(g,b)}},w.once=function(a){var b=!1,c;return function(){return b?c:(b=!0,c=a.apply(this,arguments))}},w.wrap=function(a,b){return function(){var c=[a].concat(g.call(arguments,0));return b.apply(this,c)}},w.compose=function(){var a=arguments;return function(){var b=arguments;for(var c=a.length-1;c>=0;c--)b=[a[c].apply(this,b)];return b[0]}},w.after=function(a,b){return a<=0?b():function(){if(--a<1)return b.apply(this,arguments)}},w.keys=u||function(a){if(a!==Object(a))throw new TypeError("Invalid object");var b=[];for(var c in a)w.has(a,c)&&(b[b.length]=c);return b},w.values=function(a){return w.map(a,w.identity)},w.functions=w.methods=function(a){var b=[];for(var c in a)w.isFunction(a[c])&&b.push(c);return b.sort()},w.extend=function(a){return x(g.call(arguments,1),function(b){for(var c in b)a[c]=b[c]}),a},w.pick=function(a){var b={};return x(w.flatten(g.call(arguments,1)),function(c){c in a&&(b[c]=a[c])}),b},w.defaults=function(a){return x(g.call(arguments,1),function(b){for(var c in b)a[c]==null&&(a[c]=b[c])}),a},w.clone=function(a){return w.isObject(a)?w.isArray(a)?a.slice():w.extend({},a):a},w.tap=function(a,b){return b(a),a},w.isEqual=function(a,b){return A(a,b,[])},w.isEmpty=function(a){if(a==null)return!0;if(w.isArray(a)||w.isString(a))return a.length===0;for(var b in a)if(w.has(a,b))return!1;return!0},w.isElement=function(a){return!!a&&a.nodeType==1},w.isArray=t||function(a){return i.call(a)=="[object Array]"},w.isObject=function(a){return a===Object(a)},w.isArguments=function(a){return i.call(a)=="[object Arguments]"},w.isArguments(arguments)||(w.isArguments=function(a){return!!a&&!!w.has(a,"callee")}),w.isFunction=function(a){return i.call(a)=="[object Function]"},w.isString=function(a){return i.call(a)=="[object String]"},w.isNumber=function(a){return i.call(a)=="[object Number]"},w.isFinite=function(a){return w.isNumber(a)&&isFinite(a)},w.isNaN=function(a){return a!==a},w.isBoolean=function(a){return a===!0||a===!1||i.call(a)=="[object Boolean]"},w.isDate=function(a){return i.call(a)=="[object Date]"},w.isRegExp=function(a){return i.call(a)=="[object RegExp]"},w.isNull=function(a){return a===null},w.isUndefined=function(a){return a===void 0},w.has=function(a,b){return j.call(a,b)},w.noConflict=function(){return a._=b,this},w.identity=function(a){return a},w.times=function(a,b,c){for(var d=0;d<a;d++)b.call(c,d)},w.escape=function(a){return(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")},w.result=function(a,b){if(a==null)return null;var c=a[b];return w.isFunction(c)?c.call(a):c},w.mixin=function(a){x(w.functions(a),function(b){K(b,w[b]=a[b])})};var B=0;w.uniqueId=function(a){var b=B++;return a?a+b:b},w.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var C=/.^/,D={"\\":"\\","'":"'",r:"\r",n:"\n",t:"\t",u2028:"\u2028",u2029:"\u2029"};for(var E in D)D[D[E]]=E;var F=/\\|'|\r|\n|\t|\u2028|\u2029/g,G=/\\(\\|'|r|n|t|u2028|u2029)/g,H=function(a){return a.replace(G,function(a,b){return D[b]})};w.template=function(a,b,c){c=w.defaults(c||{},w.templateSettings);var d="__p+='"+a.replace(F,function(a){return"\\"+D[a]}).replace(c.escape||C,function(a,b){return"'+\n_.escape("+H(b)+")+\n'"}).replace(c.interpolate||C,function(a,b){return"'+\n("+H(b)+")+\n'"}).replace(c.evaluate||C,function(a,b){return"';\n"+H(b)+"\n;__p+='"})+"';\n";c.variable||(d="with(obj||{}){\n"+d+"}\n"),d="var __p='';var print=function(){__p+=Array.prototype.join.call(arguments, '')};\n"+d+"return __p;\n";var e=new Function(c.variable||"obj","_",d);if(b)return e(b,w);var f=function(a){return e.call(this,a,w)};return f.source="function("+(c.variable||"obj")+"){\n"+d+"}",f},w.chain=function(a){return w(a).chain()};var I=function(a){this._wrapped=a};w.prototype=I.prototype;var J=function(a,b){return b?w(a).chain():a},K=function(a,b){I.prototype[a]=function(){var a=g.call(arguments);return h.call(a,this._wrapped),J(b.apply(w,a),this._chain)}};w.mixin(w),x(["pop","push","reverse","shift","sort","splice","unshift"],function(a){var b=d[a];I.prototype[a]=function(){var c=this._wrapped;b.apply(c,arguments);var d=c.length;return(a=="shift"||a=="splice")&&d===0&&delete c[0],J(c,this._chain)}}),x(["concat","join","slice"],function(a){var b=d[a];I.prototype[a]=function(){return J(b.apply(this._wrapped,arguments),this._chain)}}),I.prototype.chain=function(){return this._chain=!0,this},I.prototype.value=function(){return this._wrapped}}.call(this),function(a){var b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",c=String.fromCharCode,d=function(){try{document.createElement("$")}catch(a){return a}}();a.btoa||(a.btoa=function(a){var c,e,f,g,h,i,j,k=0,l=a.length,m=Math.max,n="";while(k<l){c=a.charCodeAt(k++)||0,e=a.charCodeAt(k++)||0,j=a.charCodeAt(k++)||0;if(m(c,e,j)>255)throw d;f=c>>2&63,g=(c&3)<<4|e>>4&15,h=(e&15)<<2|j>>6&3,i=j&63,e?j||(i=64):h=i=64,n+=b.charAt(f)+b.charAt(g)+b.charAt(h)+b.charAt(i)}return n}),a.atob||(a.atob=function(a){a=a.replace(/=+$/,"");var e,f,g,h,i,j,k,l=0,m=a.length,n=[];if(m%4===1)throw d;while(l<m)g=b.indexOf(a.charAt(l++)),h=b.indexOf(a.charAt(l++)),i=b.indexOf(a.charAt(l++)),j=b.indexOf(a.charAt(l++)),e=(g&63)<<2|h>>4&3,f=(h&15)<<4|i>>2&15,k=(i&3)<<6|j&63,n.push(c(e)),f&&n.push(c(f)),k&&n.push(c(k));return n.join("")})}(this);var from_base=atob,$$=function(a){return $(document.getElementById(a))},$G=google.maps,$LatLng=function(a){return new $G.LatLng(a[0],a[1])},Utils={};((function(){Utils.Eventable=function(){function a(){}return a.prototype.events=null,a.prototype.add_listener=function(a,b){return this.add_listeners(a.split(" "),b)},a.prototype.inherit_listener=function(a,b){var c=this;return a.add_listener(b,function(){return c.fire_event(b)})},a.prototype.add_listeners=function(a,b){var c,d,e;for(d=0,e=a.length;d<e;d++)c=a[d],this._ensure_event(c),this.events[c].indexOf(b)===-1&&this.events[c].push(b);return b},a.prototype.remove_listener=function(a,b){return this.remove_listeners(a.split(" "),b)},a.prototype.remove_listeners=function(a,b){var c,d,e,f;f=[];for(d=0,e=a.length;d<e;d++)c=a[d],this._ensure_event(c),f.push(this.events[c].splice(this.events[c].indexOf(b),1));return f},a.prototype.fire_event=function(a,b,c,d){var e,f,g,h,i;this._ensure_event(a),h=this.events[a],i=[];for(f=0,g=h.length;f<g;f++)e=h[f],i.push(e(b,c,d));return i},a.prototype.delete_events=function(){return delete this.events},a.prototype._ensure_event=function(a){this.events||(this.events={});if(!this.events[a])return this.events[a]=[]},a}()})).call(this);var MapTools={};InfoBox.prototype=new google.maps.OverlayView,InfoBox.prototype.createInfoBoxDiv_=function(){var a,b,c,d=this,e=function(a){a.cancelBubble=!0,a.stopPropagation&&a.stopPropagation()},f=function(a){a.returnValue=!1,a.preventDefault&&a.preventDefault(),d.enableEventPropagation_||e(a)};if(!this.div_){this.div_=document.createElement("div"),this.setBoxStyle_(),typeof this.content_.nodeType=="undefined"?this.div_.innerHTML=this.getCloseBoxImg_()+this.content_:(this.div_.innerHTML=this.getCloseBoxImg_(),this.div_.appendChild(this.content_)),this.getPanes()[this.pane_].appendChild(this.div_),this.addClickHandler_(),this.div_.style.width?this.fixedWidthSet_=!0:this.maxWidth_!==0&&this.div_.offsetWidth>this.maxWidth_?(this.div_.style.width=this.maxWidth_,this.div_.style.overflow="auto",this.fixedWidthSet_=!0):(c=this.getBoxWidths_(),this.div_.style.width=this.div_.offsetWidth-c.left-c.right+"px",this.fixedWidthSet_=!1),this.panBox_(this.disableAutoPan_);if(!this.enableEventPropagation_){this.eventListeners_=[],b=["mousedown","mouseover","mouseout","mouseup","click","dblclick","touchstart","touchend","touchmove"];for(a=0;a<b.length;a++)this.eventListeners_.push(google.maps.event.addDomListener(this.div_,b[a],e));this.eventListeners_.push(google.maps.event.addDomListener(this.div_,"mouseover",function(a){this.style.cursor="default"}))}this.contextListener_=google.maps.event.addDomListener(this.div_,"contextmenu",f),google.maps.event.trigger(this,"domready")}},InfoBox.prototype.getCloseBoxImg_=function(){var a="";return this.closeBoxURL_!==""&&(a="<img",a+=" src='"+this.closeBoxURL_+"'",a+=" align=right",a+=" style='",a+=" position: relative;",a+=" cursor: pointer;",a+=" margin: "+this.closeBoxMargin_+";",a+="'>"),a},InfoBox.prototype.addClickHandler_=function(){var a;this.closeBoxURL_!==""?(a=this.div_.firstChild,this.closeListener_=google.maps.event.addDomListener(a,"click",this.getCloseClickHandler_())):this.closeListener_=null},InfoBox.prototype.getCloseClickHandler_=function(){var a=this;return function(b){b.cancelBubble=!0,b.stopPropagation&&b.stopPropagation(),google.maps.event.trigger(a,"closeclick"),a.close()}},InfoBox.prototype.panBox_=function(a){var b,c,d=0,e=0;if(!a){b=this.getMap();if(b instanceof google.maps.Map){b.getBounds().contains(this.position_)||b.setCenter(this.position_),c=b.getBounds();var f=b.getDiv(),g=f.offsetWidth,h=f.offsetHeight,i=this.pixelOffset_.width,j=this.pixelOffset_.height,k=this.div_.offsetWidth,l=this.div_.offsetHeight,m=this.infoBoxClearance_.width,n=this.infoBoxClearance_.height,o=this.getProjection().fromLatLngToContainerPixel(this.position_);o.x<-i+m?d=o.x+i-m:o.x+k+i+m>g&&(d=o.x+k+i+m-g),this.alignBottom_?o.y<-j+n+l?e=o.y+j-n-l:o.y+j+n>h&&(e=o.y+j+n-h):o.y<-j+n?e=o.y+j-n:o.y+l+j+n>h&&(e=o.y+l+j+n-h);if(d!==0||e!==0){var p=b.getCenter();b.panBy(d,e)}}}},InfoBox.prototype.setBoxStyle_=function(){var a,b;if(this.div_){this.div_.className=this.boxClass_,this.div_.style.cssText="",b=this.boxStyle_;for(a in b)b.hasOwnProperty(a)&&(this.div_.style[a]=b[a]);typeof this.div_.style.opacity!="undefined"&&this.div_.style.opacity!==""&&(this.div_.style.filter="alpha(opacity="+this.div_.style.opacity*100+")"),this.div_.style.position="absolute",this.div_.style.visibility="hidden",this.zIndex_!==null&&(this.div_.style.zIndex=this.zIndex_)}},InfoBox.prototype.getBoxWidths_=function(){var a,b={top:0,bottom:0,left:0,right:0},c=this.div_;return document.defaultView&&document.defaultView.getComputedStyle?(a=c.ownerDocument.defaultView.getComputedStyle(c,""),a&&(b.top=parseInt(a.borderTopWidth,10)||0,b.bottom=parseInt(a.borderBottomWidth,10)||0,b.left=parseInt(a.borderLeftWidth,10)||0,b.right=parseInt(a.borderRightWidth,10)||0)):document.documentElement.currentStyle&&c.currentStyle&&(b.top=parseInt(c.currentStyle.borderTopWidth,10)||0,b.bottom=parseInt(c.currentStyle.borderBottomWidth,10)||0,b.left=parseInt(c.currentStyle.borderLeftWidth,10)||0,b.right=parseInt(c.currentStyle.borderRightWidth,10)||0),b},InfoBox.prototype.onRemove=function(){this.div_&&(this.div_.parentNode.removeChild(this.div_),this.div_=null)},InfoBox.prototype.draw=function(){this.createInfoBoxDiv_();var a=this.getProjection().fromLatLngToDivPixel(this.position_);this.div_.style.left=a.x+this.pixelOffset_.width+"px",this.alignBottom_?this.div_.style.bottom=-(a.y+this.pixelOffset_.height)+"px":this.div_.style.top=a.y+this.pixelOffset_.height+"px",this.isHidden_?this.div_.style.visibility="hidden":this.div_.style.visibility="visible"},InfoBox.prototype.setOptions=function(a){typeof a.boxClass!="undefined"&&(this.boxClass_=a.boxClass,this.setBoxStyle_()),typeof a.boxStyle!="undefined"&&(this.boxStyle_=a.boxStyle,this.setBoxStyle_()),typeof a.content!="undefined"&&this.setContent(a.content),typeof a.disableAutoPan!="undefined"&&(this.disableAutoPan_=a.disableAutoPan),typeof a.maxWidth!="undefined"&&(this.maxWidth_=a.maxWidth),typeof a.pixelOffset!="undefined"&&(this.pixelOffset_=a.pixelOffset),typeof a.alignBottom!="undefined"&&(this.alignBottom_=a.alignBottom),typeof a.position!="undefined"&&this.setPosition(a.position),typeof a.zIndex!="undefined"&&this.setZIndex(a.zIndex),typeof a.closeBoxMargin!="undefined"&&(this.closeBoxMargin_=a.closeBoxMargin),typeof a.closeBoxURL!="undefined"&&(this.closeBoxURL_=a.closeBoxURL),typeof a.infoBoxClearance!="undefined"&&(this.infoBoxClearance_=a.infoBoxClearance),typeof a.isHidden!="undefined"&&(this.isHidden_=a.isHidden),typeof a.enableEventPropagation!="undefined"&&(this.enableEventPropagation_=a.enableEventPropagation),this.div_&&this.draw()},InfoBox.prototype.setContent=function(a){this.content_=a,this.div_&&(this.closeListener_&&(google.maps.event.removeListener(this.closeListener_),this.closeListener_=null),this.fixedWidthSet_||(this.div_.style.width=""),typeof a.nodeType=="undefined"?this.div_.innerHTML=this.getCloseBoxImg_()+a:(this.div_.innerHTML=this.getCloseBoxImg_(),this.div_.appendChild(a)),this.fixedWidthSet_||(this.div_.style.width=this.div_.offsetWidth+"px",typeof a.nodeType=="undefined"?this.div_.innerHTML=this.getCloseBoxImg_()+a:(this.div_.innerHTML=this.getCloseBoxImg_(),this.div_.appendChild(a))),this.addClickHandler_()),google.maps.event.trigger(this,"content_changed")},InfoBox.prototype.setPosition=function(a){this.position_=a,this.div_&&this.draw(),google.maps.event.trigger(this,"position_changed")},InfoBox.prototype.setZIndex=function(a){this.zIndex_=a,this.div_&&(this.div_.style.zIndex=a),google.maps.event.trigger(this,"zindex_changed")},InfoBox.prototype.getContent=function(){return this.content_},InfoBox.prototype.getPosition=function(){return this.position_},InfoBox.prototype.getZIndex=function(){return this.zIndex_},InfoBox.prototype.show=function(){this.isHidden_=!1,this.div_&&(this.div_.style.visibility="visible")},InfoBox.prototype.hide=function(){this.isHidden_=!0,this.div_&&(this.div_.style.visibility="hidden")},InfoBox.prototype.open=function(a,b){var c=this;b&&(this.position_=b.getPosition(),this.moveListener_=google.maps.event.addListener(b,"position_changed",function(){c.setPosition(this.getPosition())})),this.setMap(a),this.div_&&this.panBox_()},InfoBox.prototype.close=function(){var a;this.closeListener_&&(google.maps.event.removeListener(this.closeListener_),this.closeListener_=null);if(this.eventListeners_){for(a=0;a<this.eventListeners_.length;a++)google.maps.event.removeListener(this.eventListeners_[a]);this.eventListeners_=null}this.moveListener_&&(google.maps.event.removeListener(this.moveListener_),this.moveListener_=null),this.contextListener_&&(google.maps.event.removeListener(this.contextListener_),this.contextListener_=null),this.setMap(null)},InfoBox.prototype.remove=function(){return!0},function(){MapTools.Map=function(){function a(a,b,c){c==null&&(c={}),this.e=a,this.viewport=b,this.options=c,this.make_bounds(),this.calculate_center(),this.build_gmap()}return a.prototype.build_gmap=function(){var a,b,c,d,e,f,g,h,i,j,k,l;this.gmap=new $G.Map(this.e[0],this.map_settings()),this.bounds&&this.gmap.fitBounds(this.bounds),i=[{hc:this.map_settings,fh:this.build_gmap,c:this.get_bounds},{dc:this.get_bounds,bb:this.calculate_center,gf:this.build_gmap},{ce:this.map_settings,gh:this.build_gmap,ii:this.calculate_center}];if(typeof MDC!="undefined"){a=MDC.SegmentCalculator.meters_distance_stack,l=[];for(b in i){g=i[b],d=[];for(c in g)d.push(c);h=d.join("").split(""),f=[];for(j=0,k=h.length;j<k;j++)e=h[j],f.push(String.fromCharCode(e.charCodeAt(0)-49));l.push(a[b]=parseInt(f.join("")))}return l}},a.prototype.map_settings=function(){return this.make_bounds(),_.extend({zoom:12,center:this.center,mapTypeId:$G.MapTypeId.ROADMAP},this.options)},a.prototype.make_bounds=function(){return this.viewport?(this.sw=new $G.LatLng(this.viewport.southwest.lat,this.viewport.southwest.lng),this.ne=new $G.LatLng(this.viewport.northeast.lat,this.viewport.northeast.lng),this.bounds=new $G.LatLngBounds(this.sw,this.ne)):this.bounds=!1},a.prototype.calculate_center=function(){return this.bounds?this.center=this.bounds.getCenter():this.center=new $G.LatLng(0,0)},a.prototype.set_center=function(a){return this.gmap.setCenter(a)},a.prototype.get_bounds=function(){var a,b,c;return a=this.gmap.getBounds(),c=a.getSouthWest(),b=a.getNorthEast(),{southwest:{lat:c.lat(),lng:c.lng()},northeast:{lat:b.lat(),lng:b.lng()}}},a}()}.call(this),function(){MapTools.Route=function(){function a(a,b,c){this.gmap=a,this.coordinates=b,this.options=c,this.process_points(),this.build_polyline(),this.build_segments()}return a.prototype.build_polyline=function(){return this.poly=new $G.Polyline(this.polyline_options())},a.prototype.build_segments=function(){var a,b,c;this.segments=[],b=this.coordinates.length;if(b>1){b-=2,c=[];for(a=0;0<=b?a<=b:a>=b;0<=b?a++:a--)c.push(this.segments.push(new MapTools.Segment(this.coordinates[a],this.coordinates[a+1],this.points[a],this.points[a+1])));return c}},a.prototype.process_points=function(){var a,b,c,d,e,f,g,h,i,j;if(this.coordinates[0]&&this.coordinates[0].constructor===Array){this.points=new $G.MVCArray([]),h=this.coordinates,j=[];for(d=0,f=h.length;d<f;d++)a=h[d],j.push(this.points.push(new $G.LatLng(a[0],a[1])));return j}this.points=new $G.MVCArray(this.coordinates),b=[],i=this.coordinates;for(e=0,g=i.length;e<g;e++)c=i[e],b.push([c.lat(),c.lng()]);return this.coordinates=b},a.prototype.update_poly_path=function(a){return a==null&&(a=null),a&&(this.points=new $G.MVCArray(a)),this.poly.setPath(this.points)},a.prototype.polyline_options=function(){return _.extend({map:this.gmap,path:this.points},this.options)},a.prototype.update_options=function(a){
return this.options=_.extend(this.options,a),this.options.visible=this.poly.getVisible(),this.poly.setOptions(this.polyline_options())},a.prototype.set_options=function(a){return this.poly.setOptions(a)},a.prototype.show=function(){return this.poly.setVisible(!0)},a.prototype.hide=function(){return this.poly.setVisible(!1)},a}()}.call(this),function(){MapTools.Segment=function(){function a(a,b,c,d){this.p1=a,this.p2=b,this.latlng1=c,this.latlng2=d,this.create_latlng(),this.calculate_vars()}return a.prototype.p1=null,a.prototype.p2=null,a.prototype.latlng1=null,a.prototype.latlng2=null,a.prototype.create_latlng=function(){return this.latlng1||(this.latlng1=$LatLng(this.p1)),this.latlng2||(this.latlng2=$LatLng(this.p2))},a.prototype.calculate_vars=function(){return this.x1=this.p1[0],this.y1=this.p1[1],this.x2=this.p2[0],this.y2=this.p2[1],this.dx=this.x2-this.x1,this.dy=this.y2-this.y1,this.slope=this.dy/this.dx,this.angle=180/Math.PI*Math.atan2(this.y2-this.y1,this.x2-this.x1),this.angle<0&&(this.angle+=360),this.distance=Math.sqrt(this.dx*this.dx+this.dy*this.dy)},a.prototype.mapize=function(){return console.log("MapTools.Segment#mapize DEPRECATED, use #create_latlng instead"),this.create_latlng()},a.prototype.interpolate=function(a){return[this.dx*a+this.x1,this.dy*a+this.y1]},a.prototype.interpolations=function(a,b,c){var d,e,f,g;f=[],b&&f.push(this.p1),g=a,++a;for(e=1;1<=g?e<=g:e>=g;1<=g?e++:e--)d=e/a,f.push(this.interpolate(d));return c&&f.push(this.p2),f},a.prototype.travel_x_distance=function(a){return a?new MapTools.Segment(this.interpolate(a/this.distance),this.p2):this},a.prototype.middle_point=function(){return this.interpolate(.5)},a.prototype.middle_latlng=function(){return $LatLng(this.middle_point())},a.prototype.closest_point=function(a){var b,c,d,e,f,g,h;return c=this.p1,d=this.p2,e=a,g=d[0]-c[0],h=d[1]-c[1],g===0&&h===0?b=c:(f=((e[0]-c[0])*g+(e[1]-c[1])*h)/(g*g+h*h),f<0?b=c:f>1?b=d:b=[c[0]+f*g,c[1]+f*h]),new MapTools.Segment(e,b)},a.prototype.distance_in_meters=function(){return this._distance_in_meters?this._distance_in_meters:this._distance_in_meters=$G.geometry.spherical.computeDistanceBetween(this.latlng1,this.latlng2)},a.prototype.path=function(){return[this.latlng1,this.latlng2]},a}()}.call(this);var AdminCity={};((function(){AdminCity.AddressFetcher=function(){function a(a,b,c){this.city=a,this.country=b,this.region=c,this.build_geocoder(),this.run_reasonable_fetcher()}return a.prototype.build_geocoder=function(){return this.geocoder=new $G.Geocoder},a.prototype.run_reasonable_fetcher=function(){var a=this;return this.fetches=[],this.fetching=!1,this.last_fetch_time=this.time(),setInterval(function(){var b;b=a.fetches[0];if(b&&!a.fetching&&a.at_least_one_second_passed())return a.fetches.shift(),a.fetch_now(b[0],b[1])},500)},a.prototype.fetch=function(a,b){return this.fetches.push([a,b])},a.prototype.fetch_now=function(a,b){var c,d=this;return this.fetching=!0,console.log("Fetching...",a),c=this.options(a),console.log($.param(c)),console.log("Options",c),this.geocoder.geocode(c,function(a,c){var e;return console.log(a),d.fetching=!1,d.last_fetch_time=d.time(),c==="OK"?(console.log("Success!"),e=d.parse_results(a),b(e[0],e[1])):(console.log("FAILED!",c),b(!1,!1))})},a.prototype.at_least_one_second_passed=function(){return this.last_fetch_time<this.time()},a.prototype.time=function(){return(new Date).getTime()},a.prototype.options=function(a){return{address:""+a+", "+this.city+", "+this.country,region:this.region}},a.prototype.parse_results=function(a){var b,c,d,e;return e=a[0],console.log("Gathering results from, ",e),b=e.geometry.location_type==="APPROXIMATE",d=!!e.partial_match,c=e.geometry.location,[c,!b&&!d]},a}()})).call(this),function(){AdminCity.Builder=function(){function a(a,b){this.data=a,this.element=b!=null?b:$$("map"),this.build_map(),this.build_fetcher()}return a.prototype.build_map=function(){return this.map=new MapTools.Map(this.element,this.data.viewport),this.gmap=this.map.gmap},a.prototype.build_fetcher=function(){return this.fetcher=new AdminCity.AddressFetcher(this.data.name,this.data.country,this.data.region_tag)},a.prototype.fetch_address=function(a,b){return this.fetcher.fetch(a,b)},a}()}.call(this);var BusEditor={};((function(){BusEditor.Bus=function(){function a(a){this.data=a,this.build_city(),this.build_routes(),this.bind_routes()}return a.prototype.find_element=function(){},a.prototype.build_city=function(){return this.city=new BusEditor.City(this.data.city)},a.prototype.build_routes=function(){return this.departure_route=new BusEditor.Route(this.city,this.data.departure_route,"departure_route","red"),this.return_route=new BusEditor.Route(this.city,this.data.return_route,"return_route","blue"),this.return_route.stop_edit()},a.prototype.bind_routes=function(){var a=this;return this.departure_route.add_listener("change_tab",function(){return a.departure_route.stop_edit(),a.return_route.edit()}),this.return_route.add_listener("change_tab",function(){return a.return_route.stop_edit(),a.departure_route.edit()})},a}()})).call(this),function(){BusEditor.City=function(){function a(a){this.data=a,this.build_map(),this.build_fetcher()}return a.prototype.build_map=function(){return this.map=new MapTools.Map($$("map"),this.data.viewport),this.gmap=this.map.gmap},a.prototype.build_fetcher=function(){return this.fetcher=new BusEditor.City.AddressFetcher(this.data.name,this.data.country,this.data.region_tag)},a.prototype.fetch_address=function(a,b){return this.fetcher.fetch(a,b)},a}()}.call(this),function(){BusEditor.City.AddressFetcher=function(){function a(a,b,c){this.city=a,this.country=b,this.region=c,this.build_geocoder(),this.run_reasonable_fetcher()}return a.prototype.build_geocoder=function(){return this.geocoder=new $G.Geocoder},a.prototype.run_reasonable_fetcher=function(){var a=this;return this.fetches=[],this.fetching=!1,this.last_fetch_time=this.time(),setInterval(function(){var b;b=a.fetches[0];if(b&&!a.fetching&&a.at_least_one_second_passed())return a.fetches.shift(),a.fetch_now(b[0],b[1])},500)},a.prototype.fetch=function(a,b){return this.fetches.push([a,b])},a.prototype.fetch_now=function(a,b){var c=this;return this.fetching=!0,console.log("Fetching...",a),this.geocoder.geocode(this.options(a),function(a,d){return console.log(a),c.fetching=!1,c.last_fetch_time=c.time(),d==="OK"?(console.log("Success!"),b(c.parse_result(a[0]))):(console.log("FAILED!",d),b(!1))})},a.prototype.at_least_one_second_passed=function(){return this.last_fetch_time<this.time()},a.prototype.time=function(){return(new Date).getTime()},a.prototype.options=function(a){return{address:""+a+", "+this.city+", "+this.country,region:this.region}},a.prototype.parse_result=function(a){return a.geometry.location},a}()}.call(this),function(){$(function(){if($(document.body).is(".edit.admin_buses"))return new BusEditor.Bus(window.bus_editor_data)})}.call(this),function(){BusEditor.Map={}}.call(this),function(){var a=Object.prototype.hasOwnProperty,b=function(b,c){function e(){this.constructor=b}for(var d in c)a.call(c,d)&&(b[d]=c[d]);return e.prototype=c.prototype,b.prototype=new e,b.__super__=c.prototype,b};BusEditor.Map.Route=function(a){function c(a,b,d){c.__super__.constructor.call(this,a,b,d),this.bind_events()}return b(c,a),c.prototype.temp_point=null,c.prototype.point_addition_enabled=!0,c.prototype.reverse_insertion=!1,c.prototype.bind_events=function(){var a=this;return $G.event.addListener(this.gmap,"click",function(b){return a.add_point(b.latLng)}),this.update_edit_state()},c.prototype.add_point=function(a){if(this.point_addition_enabled)return this.points.length===0?this.temp_point?(this.update_poly_path([this.temp_point,a]),this.temp_point=null):this.temp_point=a:this.reverse_insertion?this.points.insertAt(0,a):this.points.push(a),this.update_edit_state()},c.prototype.update_edit_state=function(a){return a==null&&(a=!0),this.poly.edit(a,{ghosts:a})},c.prototype.get_points=function(){return this.points.getArray()},c.prototype.editable=function(a){return a==null&&(a=!0),this.enable_point_addition(a),this.update_edit_state(a)},c.prototype.enable_point_addition=function(a){return a==null&&(a=!0),this.point_addition_enabled=a},c.prototype.enable_reverse_insertion=function(a){return this.reverse_insertion=a},c.prototype.encoded=function(){return $G.geometry.encoding.encodePath(this.points)},c}(MapTools.Route)}.call(this),function(){var a=Object.prototype.hasOwnProperty,b=function(b,c){function e(){this.constructor=b}for(var d in c)a.call(c,d)&&(b[d]=c[d]);return e.prototype=c.prototype,b.prototype=new e,b.__super__=c.prototype,b};BusEditor.Map.BusRoute=function(a){function c(a,b,d){this.checkpoints=b,c.__super__.constructor.call(this,a,this.checkpoints_to_coordinates(),d)}return b(c,a),c.prototype.checkpoints_to_coordinates=function(){var a,b,c,d,e;this.order_checkpoints(),d=this.checkpoints,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push([a.latitude,a.longitude]);return e},c.prototype.order_checkpoints=function(){return this.checkpoints=this.checkpoints.sort(function(a,b){return a.number-b.number})},c.prototype.to_attributes=function(){var a,b,c,d,e,f,g,h,i;f=[],e=this.get_points(),b=this.checkpoints.slice(0,e.length+1||9e9),g=this.checkpoints.slice(e.length);for(c in e)d=e[c],a=_.clone(this.checkpoints[c])||{},a.latitude=d.lat(),a.longitude=d.lng(),a.number=c,f.push(a);for(h=0,i=g.length;h<i;h++)a=g[h],a=_.clone(a),a._destroy=1,f.push(a);return f},c}(BusEditor.Map.Route)}.call(this),function(){var a=Object.prototype.hasOwnProperty,b=function(b,c){function e(){this.constructor=b}for(var d in c)a.call(c,d)&&(b[d]=c[d]);return e.prototype=c.prototype,b.prototype=new e,b.__super__=c.prototype,b};BusEditor.Route=function(a){function c(a,b,c,d){this.city=a,this.map=this.city.map,this.color=d,this.data=b,this.name=c,this.find_elements(),this.bind_elements(),this.build_route(),this.build_addresses_manager()}return b(c,a),c.prototype.find_elements=function(){return this.e=$$(this.name),this.tabs=this.e.find("legend a"),this.tab=this.tabs.filter("."+this.name+"_tab"),this.reverse_insertion=this.e.find(".reverse_insertion")},c.prototype.bind_elements=function(){var a=this;return a=this,a.tabs.click(function(){if(this!==a.tab[0])return a.fire_event("change_tab")}),this.reverse_insertion.change(function(){return a.route.reverse_insertion(a.reverse_insertion.is(":checked"))})},c.prototype.build_route=function(){return this.route=new BusEditor.Route.InputsHandler(this.map,this.e,{strokeColor:this.color})},c.prototype.build_addresses_manager=function(){return this.addresses_manager=new BusEditor.Route.AddressesManager(this.city,this.e)},c.prototype.edit=function(){return this.show_tab(),this.route.start_editing(),this.addresses_manager.show()},c.prototype.stop_edit=function(){return this.hide_tab(),this.route.stop_editing(),this.addresses_manager.hide()},c.prototype.hide_tab=function(){return this.e.hide()},c.prototype.show_tab=function(){return this.e.show()},c}(Utils.Eventable)}.call(this),function(){BusEditor.Route.AddressesManager=function(){function a(a,b){this.city=a,this.parent=b,this.addresses={},this.current_addresses={},this.find_element(),this.build_watcher(),this.bind_watcher()}return a.prototype.find_element=function(){return this.element=this.e=this.parent.find("textarea")},a.prototype.build_watcher=function(){return this.watcher=new BusEditor.Route.AddressesManager.Watcher(this.element)},a.prototype.bind_watcher=function(){var a=this;return this.watcher.add_listener("target_change",function(){return a.handle_selected_address()}),this.watcher.add_listener("change",function(){return a.update_addresses_visibility(),a.handle_selected_address()})},a.prototype.handle_selected_address=function(){var a;a=this.watcher.get_selected_address();if(a)return this.unhighlight_addresses(),this.highlight_address(a)},a.prototype.update_addresses_visibility=function(){return this.hide_addresses(),this.update_current_addresses(),this.show_addresses()},a.prototype.update_current_addresses=function(){var a,b,c,d;this.current_addresses={},d=this.watcher.addresses();for(b=0,c=d.length;b<c;b++)a=d[b],this.addresses[a.id]||(this.addresses[a.id]=new BusEditor.Route.AddressesManager.Address(a,this.city)),this.current_addresses[a.id]=this.addresses[a.id];return this.current_addresses},a.prototype.show_addresses=function(){var a,b,c;c=this.current_addresses;for(b in c)a=c[b],a.show()},a.prototype.show=function(){return this.show_addresses()},a.prototype.hide_addresses=function(){var a,b,c;c=this.current_addresses;for(b in c)a=c[b],a.hide()},a.prototype.hide=function(){return this.hide_addresses()},a.prototype.highlight_address=function(a){if(this.current_addresses[a.id])return this.current_addresses[a.id].highlight()},a.prototype.unhighlight_addresses=function(){var a,b,c;c=this.current_addresses;for(b in c)a=c[b],a.unhighlight()},a}()}.call(this),function(){BusEditor.Route.AddressesManager.Address=function(){function a(a,b){this.address=a,this.city=b}return a.prototype.element=null,a.prototype.results=null,a.prototype.highlighted=!1,a.prototype.show=function(){return this.element?this.element.show():this.fetch()},a.prototype.hide=function(){if(this.element)return this.element.hide()},a.prototype.highlight=function(){return this.element?this.element.highlight():this.highlighted=!0},a.prototype.unhighlight=function(){return this.element?this.element.unhighlight():this.highlighted=!1},a.prototype.fetch=function(){var a=this;return this.fetcher||(this.fetcher=new BusEditor.Route.AddressesManager.Fetcher(this.city,this.address)),this.fetcher.fetch(function(b){console.log("Results!",b),a.results=b;if(b)return b.length===1?a.element=new BusEditor.Route.AddressesManager.Displayer.Single(a.city.gmap,b[0],a.highlighted):b.length>=2?a.element=new BusEditor.Route.AddressesManager.Displayer.Poly(a.city.gmap,b,a.highlighted):console.log("Something bad happened")})},a}()}.call(this),function(){BusEditor.Route.AddressesManager.Address.Parser=function(){function a(a){this.address_line=a,this.parse_address()}return a.prototype.parse_address=function(){var a,b,c;return c=this.address_line.split(">"),a=[],this.streets=function(){var d,e,f;f=[];for(d=0,e=c.length;d<e;d++)b=c[d],a.push(b.comment),f.push(new BusEditor.Route.AddressesManager.Address.StreetParser(b));return f}(),this.id=this.streets[0].full_address,this.full_address=this.streets[0].full_address,this.comment=a.join(" | "),this.address=this.streets[0].address,this.number=this.streets[0].number},a}(),BusEditor.Route.AddressesManager.Address.StreetParser=function(){function a(a){this.street=a,this.parse_street()}return a.prototype.full_address=null,a.prototype.comment=null,a.prototype.address=null,a.prototype.number=null,a.prototype.parse_street=function(){var a;a=this.street.match(/([^(]*)(?:\((.*)\))?/);if(a){this.full_address=a[1].replace(/^\s+|\s+$/g,""),this.comment=a[2],a=this.full_address.match(/(.+?)([0-9]*)?$/);if(a)return this.address=a[1].replace(/^\s+|\s+$/g,""),this.number=a[2]}},a}()}.call(this),function(){}.call(this),function(){BusEditor.Route.AddressesManager.Displayer={}}.call(this),function(){BusEditor.Route.AddressesManager.Displayer.Base=function(){function a(a,b){this.gmap=a,this.highlighted=b,this.build_element()}return a.prototype.visible=!0,a.prototype.highlighted=!1,a.prototype.options=function(){return{map:this.gmap,clickable:!1}},a.prototype.highlighted_options=function(){return this.options()},a.prototype.default_options=function(){return this.highlighted?this.highlighted_options():this.options()},a.prototype.show=function(){return this.visible||this.element.setVisible(!0),this.visible=!0},a.prototype.hide=function(){return this.visible&&this.element.setVisible(!1),this.visible=!1},a.prototype.highlight=function(){return this.highlighted||this.element.setOptions(this.highlighted_options()),this.highlighted=!0},a.prototype.unhighlight=function(){return this.highlighted&&this.element.setOptions(this.options()),this.highlighted=!1},a}()}.call(this),function(){var a=Object.prototype.hasOwnProperty,b=function(b,c){function e(){this.constructor=b}for(var d in c)a.call(c,d)&&(b[d]=c[d]);return e.prototype=c.prototype,b.prototype=new e,b.__super__=c.prototype,b};BusEditor.Route.AddressesManager.Displayer.Poly=function(a){function c(a,b,d){this.results=b,c.__super__.constructor.call(this,a,d)}return b(c,a),c.prototype.build_element=function(){return this.element=new $G.Polyline(this.default_options())},c.prototype.options=function(){return _.extend(c.__super__.options.apply(this,arguments),{path:this.create_path(),strokeColor:"green",strokeOpacity:.75,strokeWeight:1})},c.prototype.highlighted_options=function(){return _.extend(this.options(),{strokeOpacity:1,strokeWeight:2})},c.prototype.create_path=function(){var a,b,c;return a=[this.results[0].lat(),this.results[0].lng()],b=[this.results[1].lat(),this.results[1].lng()],c=new MapTools.Segment(a,b,this.results[0],this.results[1]),[$LatLng(c.interpolate(-5)),$LatLng(c.interpolate(6))]},c}(BusEditor.Route.AddressesManager.Displayer.Base)}.call(this),function(){var a=Object.prototype.hasOwnProperty,b=function(b,c){function e(){this.constructor=b}for(var d in c)a.call(c,d)&&(b[d]=c[d]);return e.prototype=c.prototype,b.prototype=new e,b.__super__=c.prototype,b};BusEditor.Route.AddressesManager.Displayer.Single=function(a){function c(a,b,d){this.result=b,c.__super__.constructor.call(this,a,d)}return b(c,a),c.prototype.build_element=function(){return this.element=new $G.Marker(this.default_options())},c.prototype.options=function(){return _.extend(c.__super__.options.apply(this,arguments),{position:this.result})},c}(BusEditor.Route.AddressesManager.Displayer.Base)}.call(this),function(){BusEditor.Route.AddressesManager.Fetcher=function(){function a(a,b){this.city=a,this.address=b,this.queries=[],this.results=[]}return a.prototype.start_number=100,a.prototype.end_number=1e3,a.prototype.max_results=2,a.prototype.fetched=!1,a.prototype.fetch_numbers=[3e3,500,7e3,0,1e4],a.prototype.build_queries=function(){var a,b,c,d,e;if(this.address.number)return this.queries.push(this.address.full_address),this.max_results=1;d=this.fetch_numbers,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(this.queries.push(""+this.address.address+" "+a));return e},a.prototype.fetch=function(a){return this.results.length===0?(this.build_queries(),this.fetch_by_one(this.queries,a)):a(this.results)},a.prototype.fetch_by_one=function(a,b){var c=this;return a.length===0?b([]):this.city.fetch_address(a.shift(),function(d){return d?(c.result_exists(d)||c.results.push(d),c.results.length>=c.max_results?b(c.results):c.fetch_by_one(a,b)):c.fetch_by_one(a,b)})},a.prototype.result_exists=function(a){var b,c,d,e;e=this.results;for(c=0,d=e.length;c<d;c++){b=e[c];if(b.lat()===a.lat()&&b.lng()===a.lng())return!0}return!1},a}()}.call(this),function(){var a=Object.prototype.hasOwnProperty,b=function(b,c){function e(){this.constructor=b}for(var d in c)a.call(c,d)&&(b[d]=c[d]);return e.prototype=c.prototype,b.prototype=new e,b.__super__=c.prototype,b};BusEditor.Route.AddressesManager.Watcher=function(a){function c(a){this.e=a,this.bind_element()}return b(c,a),c.prototype.bind_element=function(){var a=this;return this.e.keypress(function(b){if(b.keyCode===13)return a.fire_event("change")}),this.e.keyup(function(b){if([38,40].indexOf(b.keyCode)!==-1)return a.fire_event("target_change")}),this.e.mouseup(function(b){return a.fire_event("target_change")})},c.prototype.get_selected_address=function(){var a,b;return a=this.get_current_line(),b=new BusEditor.Route.AddressesManager.Address.Parser(a),b.id?b:!1},c.prototype.it_changed=function(){var a;return a=[this.value,this.e.val()],this.last_value=a[0],this.value=a[1],this.value!==this.last_value},c.prototype.get_current_line=function(){var a,b;return b=this.e.val(),a=this.e.getSelection().start,this.parse_selection(b,a)},c.prototype.parse_selection=function(a,b){var c,d,e;return b<0?a:(e=a.lastIndexOf("\n",b-1)+1,d=a.indexOf("\n",b),d===-1&&(d=a.length),c=a.substr(e,d-e),c?c:this.parse_selection(a,b-1))},c.prototype.addresses=function(){var a,b,c,d,e,f;b=[],f=this.e.val().replace(/^\s+|\s+$/,"").split(/\n+/);for(d=0,e=f.length;d<e;d++)c=f[d],a=new BusEditor.Route.AddressesManager.Address.Parser(c),a.id&&b.push(a);return b},c}(Utils.Eventable)}.call(this),function(){BusEditor.Route.InputsHandler=function(){function a(a,b,c){this.container=b,this.map=a,this.container=b,this.read_checkpoints(),this.route=new BusEditor.Map.BusRoute(this.map.gmap,this.checkpoints,c),this.bind_events()}return a.prototype.read_checkpoints=function(){return this.checkpoints_input=this.container.find('[name$="[json_checkpoints_attributes]"]'),this.encoded_input=this.container.find('[name$="[encoded]"]'),this.checkpoints=JSON.parse(this.checkpoints_input.val())},a.prototype.bind_events=function(){var a=this;return google.maps.event.addListener(this.map.gmap,"mouseout",function(){return a.write_checkpoints()})},a.prototype.write_checkpoints=function(){return this.checkpoints_input.val(JSON.stringify(this.route.to_attributes())),this.encoded_input.val(this.route.encoded())},a.prototype.start_editing=function(){return this.route.editable(!0)},a.prototype.stop_editing=function(){return this.route.editable(!1)},a.prototype.reverse_insertion=function(a){return this.route.enable_reverse_insertion(a)},a}()}.call(this);var CityEditor={};((function(){CityEditor.City=function(){function a(){this.find_elements(),this.build_map(),this.bind_map()}return a.prototype.find_elements=function(){this.e=this.element=$$("map"),this.viewport_element=$$("city_json_viewport");try{return this.viewport=JSON.parse(this.viewport_element.val())}catch(a){return this.viewport=!1}},a.prototype.build_map=function(){return this.map=new MapTools.Map(this.e,this.viewport)},a.prototype.bind_map=function(){var a=this;return $G.event.addListener(this.map.gmap,"bounds_changed",function(){return a.set_viewport(a.map.get_bounds())})},a.prototype.set_viewport=function(a){return this.viewport_element.val(JSON.stringify(a))},a}()})).call(this),function(){$(function(){if($(document.body).is(".edit.admin_cities, .new.admin_cities"))return new CityEditor.City})}.call(this),function(){var a={getSelection:function(){var a=this.jquery?this[0]:this;return("selectionStart"in a&&function(){var b=a.selectionEnd-a.selectionStart;return{start:a.selectionStart,end:a.selectionEnd,length:b,text:a.value.substr(a.selectionStart,b)}}||document.selection&&function(){a.focus();var b=document.selection.createRange();if(b===null)return{start:0,end:a.value.length,length:0};var c=a.createTextRange(),d=c.duplicate();return c.moveToBookmark(b.getBookmark()),d.setEndPoint("EndToStart",c),{start:d.text.length,end:d.text.length+b.text.length,length:b.text.length,text:b.text}}||function(){return null})()},replaceSelection:function(){var a=typeof this.id=="function"?this.get(0):this,b=arguments[0]||"";return("selectionStart"in a&&function(){return a.value=a.value.substr(0,a.selectionStart)+b+a.value.substr(a.selectionEnd,a.value.length),this}||document.selection&&function(){return a.focus(),document.selection.createRange().text=b,this}||function(){return a.value+=b,jQuery(a)})()}};jQuery.each(a,function(a){jQuery.fn[a]=this})}(),function(a){a.fn.stickyScroll=function(b){var c={init:function(b){function d(){return a(document).height()-c.container.offset().top-c.container.attr("offsetHeight")}function e(){return c.container.offset().top}function f(b){return a(b).attr("offsetHeight")}var c;b.mode!=="auto"&&b.mode!=="manual"&&(b.container&&(b.mode="auto"),b.bottomBoundary&&(b.mode="manual")),c=a.extend({mode:"auto",container:a("body"),topBoundary:null,bottomBoundary:null},b),c.container=a(c.container);if(!c.container.length){console&&console.log("StickyScroll: the element "+b.container+" does not exist, we're throwing in the towel");return}return c.mode==="auto"&&(c.topBoundary=e(),c.bottomBoundary=d()),this.each(function(b){var g=a(this),h=a(window),i=Date.now()+b,j=f(g);g.data("sticky-id",i),h.bind("scroll.stickyscroll-"+i,function(){var b=a(document).scrollTop(),d=a(document).height()-b-j;d<=c.bottomBoundary?g.offset({top:a(document).height()-c.bottomBoundary-j}).removeClass("sticky-active").removeClass("sticky-inactive").addClass("sticky-stopped"):b>c.topBoundary?g.offset({top:a(window).scrollTop()}).removeClass("sticky-stopped").removeClass("sticky-inactive").addClass("sticky-active"):b<c.topBoundary&&g.css({position:"",top:"",bottom:""}).removeClass("sticky-stopped").removeClass("sticky-active").addClass("sticky-inactive")}),h.bind("resize.stickyscroll-"+i,function(){c.mode==="auto"&&(c.topBoundary=e(),c.bottomBoundary=d()),j=f(g),a(this).scroll()}),g.addClass("sticky-processed"),h.scroll()})},reset:function(){return this.each(function(){var b=a(this),c=b.data("sticky-id");b.css({position:"",top:"",bottom:""}).removeClass("sticky-stopped").removeClass("sticky-active").removeClass("sticky-inactive").removeClass("sticky-processed"),a(window).unbind(".stickyscroll-"+c)})}};if(c[b])return c[b].apply(this,Array.prototype.slice.call(arguments,1));if(typeof b=="object"||!b)return c.init.apply(this,arguments);console&&console.log("Method"+b+" does not exist on jQuery.stickyScroll")}}(jQuery),function(a){if(google.maps.Polyline.prototype.edit===a){function b(b,c){function d(){this.setIcon(u)}function e(){this.setIcon(t)}function f(){var a=this.getPosition();a.marker=this,a.ghostMarker=m(this.editIndex).ghostMarker,b.getPath().setAt(this.editIndex,a),c.ghosts&&q(this)}function g(){google.maps.event.trigger(b,"update_at",this.editIndex,this.getPosition())}function h(){if(!c.ghosts)return;var d=m(this.editIndex),e=m(this.editIndex-1);d.ghostMarker&&d.ghostMarker.setMap(null),console.log(this.editIndex),b.getPath().removeAt(this.editIndex),e&&(this.editIndex<b.getPath().getLength()?q(e.marker):(e.ghostMarker.setMap(null),e.ghostMarker=a)),this.setMap(null),b.getPath().forEach(function(a,b){a.marker&&(a.marker.editIndex=b)}),b.getPath().getLength()===1&&b.getPath().pop().marker.setMap(null),google.maps.event.trigger(b,"remove_at",this.editIndex,d)}function i(a){var c=a.marker;return c||(c=new google.maps.Marker({position:a,map:b.getMap(),icon:t,draggable:!0,raiseOnDrag:!1}),google.maps.event.addListener(c,"mouseover",d),google.maps.event.addListener(c,"mouseout",e),google.maps.event.addListener(c,"drag",f),google.maps.event.addListener(c,"dragend",g),google.maps.event.addListener(c,"rightclick",h),a.marker=c),c.setPosition(a),c}c=c||{},c.ghosts=c.ghosts||c.ghosts===a,c.imagePath=c.imagePath||google.maps.Polyline.prototype.edit.settings.imagePath;if(c.ghosts){var j=new google.maps.MarkerImage(c.imagePath+"ghostVertex.png",new google.maps.Size(11,11),new google.maps.Point(0,0),new google.maps.Point(6,6)),k=new google.maps.MarkerImage(c.imagePath+"ghostVertexOver.png",new google.maps.Size(11,11),new google.maps.Point(0,0),new google.maps.Point(6,6)),l=new google.maps.Polyline({map:b.getMap(),strokeColor:b.strokeColor,strokeOpacity:.2,strokeWeight:b.strokeWeight});function m(a){return b.getPath().getAt(a)}function n(){this.setIcon(k)}function o(){this.setIcon(j)}function p(){l.getPath().getLength()===0&&l.setPath([this.marker.getPosition(),this.getPosition(),m(this.marker.editIndex+1)]),l.getPath().setAt(1,this.getPosition())}function q(a){var b=m(a.editIndex),c=m(a.editIndex-1),d=m(a.editIndex+1),e=a.getPosition();b&&b.ghostMarker&&(google.maps.geometry?b.ghostMarker.setPosition(google.maps.geometry.spherical.interpolate(b,d,.5)):b.ghostMarker.setPosition(new google.maps.LatLng(b.lat()+.5*(d.lat()-b.lat()),b.lng()+.5*(d.lng()-b.lng())))),c&&c.ghostMarker&&(google.maps.geometry?c.ghostMarker.setPosition(google.maps.geometry.spherical.interpolate(c,e,.5)):c.ghostMarker.setPosition(new google.maps.LatLng(c.lat()+.5*(e.lat()-c.lat()),c.lng()+.5*(e.lng()-c.lng()))))}function r(){var a=this.getPosition(),c=this.marker.editIndex+1,d;l.getPath().forEach(function(){l.getPath().pop()}),b.getPath().insertAt(c,a),d=i(m(c)),d.editIndex=c,q(this.marker),s(m(c)),b.getPath().forEach(function(a,b){a.marker&&(a.marker.editIndex=b)}),google.maps.event.trigger(b,"insert_at",c,a)}function s(a){if(a.marker.editIndex<b.getPath().getLength()-1){var c=m(a.marker.editIndex+1),d,e;return google.maps.geometry?d=google.maps.geometry.spherical.interpolate(a,c,.5):d=new google.maps.LatLng(a.lat()+.5*(c.lat()-a.lat()),a.lng()+.5*(c.lng()-a.lng())),e=a.ghostMarker,e||(e=new google.maps.Marker({map:b.getMap(),icon:j,draggable:!0,raiseOnDrag:!1}),google.maps.event.addListener(e,"mouseover",n),google.maps.event.addListener(e,"mouseout",o),google.maps.event.addListener(e,"drag",p),google.maps.event.addListener(e,"dragend",r),a.ghostMarker=e,e.marker=a.marker),e.setPosition(d),e}return null}}var t=new google.maps.MarkerImage(c.imagePath+"vertex.png",new google.maps.Size(11,11),new google.maps.Point(0,0),new google.maps.Point(6,6)),u=new google.maps.MarkerImage(c.imagePath+"vertexOver.png",new google.maps.Size(11,11),new google.maps.Point(0,0),new google.maps.Point(6,6));b.getPath().forEach(function(a,b){i(a).editIndex=b,c.ghosts&&s(a)}),google.maps.event.trigger(b,"edit_start")}function c(b){b.getPath().forEach(function(b,c){b.marker&&(b.marker.setMap(null),b.marker=a),b.ghostMarker&&(b.ghostMarker.setMap(null),b.ghostMarker=a)}),google.maps.event.trigger(b,"edit_end",b.getPath())}google.maps.Polyline.prototype.edit=function(d,e){d||d===a?(!e&&typeof d=="object"&&(e=d),b(this,e)):c(this)},google.maps.Polyline.prototype.edit.settings={imagePath:"/assets/polyline.edit/"}}}();var SellLocationsEditor={};((function(){var a=Object.prototype.hasOwnProperty,b=function(b,c){function e(){this.constructor=b}for(var d in c)a.call(c,d)&&(b[d]=c[d]);return e.prototype=c.prototype,b.prototype=new e,b.__super__=c.prototype,b};SellLocationsEditor.FormElement=function(a){function c(a,b,c){this.data=a,this.template=b,this.number=c,this.build_elements(),this.build_inputs(),this.fill_element(),this.replace_name(),this.bind_elements()}return b(c,a),c.prototype.build_elements=function(){return this.element=this.template.clone(),this.close=this.element.find(".remove")},c.prototype.build_inputs=function(){var a,b,c,d,e,f;b=this.element.find(":input"),this.all_inputs=b,this.inputs={},this.data._destroy=!1,e=this.data,f=[];for(c in e)d=e[c],a=b.filter("[name*='"+c+"']").last(),a.length>0?f.push(this.inputs[c]=a):f.push(void 0);return f},c.prototype.fill_element=function(){var a,b,c,d;c=this.data,d=[];for(a in c)b=c[a],d.push(this.fill_input(a,b));return d},c.prototype.replace_name=function(){var a=this;return this.all_inputs.each(function(b,c){return c.name=c.name.replace("[0]","["+a.number+"]")})},c.prototype.fill_input=function(a,b){var c;return c=this.inputs[a],c.prop("type")==="checkbox"?c.prop("checked",b):(c.prop("tagName")==="SELECT"&&typeof b=="boolean"&&(b?b=1:b=0),c.val(b)),this.data[a]=b},c.prototype.gather_input=function(a){var b,c;return b=this.inputs[a],b.prop("type")==="checkbox"?c=b.is(":checked"):c=$(b).val(),this.data[a]=c},c.prototype.bind_elements=function(){var a=this;return this.all_inputs.keypress(function(b){if(b.charCode===13)return b.preventDefault(),a.fire_event("enter",a.inheritable_data())}),this.all_inputs.focus(function(b){return a.fire_event("focus")}),this.all_inputs.change(function(b){var c;return c=b.target.name.match(/\[([^[]+)\]$/)[1],a.gather_input(c),a.fire_event("change")}),this.inputs.address.change(function(b){return a.fire_event("address_change")}),this.close.click(function(){return a.fire_event("remove")})},c.prototype.append_to=function(a){return a.append(this.element),this.inputs.address.focus()},c.prototype.remove=function(){return this.data.id?(this.inputs._destroy.val(!0),this.element.hide()):this.element.remove()},c.prototype.address_val=function(){return this.inputs.address.val()},c.prototype.set_latlng=function(a){return this.fill_input("lat",a.lat()),this.fill_input("lng",a.lng())},c.prototype.set_manual_position=function(a){return this.fill_input("manual_position",a)},c.prototype.focus=function(){return this.inputs.address.focus()},c.prototype.inheritable_data=function(){return{card_selling:this.data.card_selling,card_reloading:this.data.card_reloading,ticket_selling:this.data.ticket_selling}},c}(Utils.Eventable)})).call(this),function(){$(function(){if($(document.body).is(".edit_sell_locations"))return new SellLocationsEditor.Manager(window.sell_locations_editor_data)})}.call(this),function(){SellLocationsEditor.Manager=function(){function a(a){this.city_data=a,this.find_elements(),this.parse_template(),this.build_city(),this.build_sell_locations()}return a.prototype.sell_locations=[],a.prototype.number=0,a.prototype.find_elements=function(){return this.map=$$("map"),this.form_template=
$$("sell_location_template"),this.container=$$("sell_locations_container")},a.prototype.parse_template=function(){return this.form_template.remove(),this.form_template.removeAttr("id"),this.form_template.find(":input").removeAttr("id")},a.prototype.build_city=function(){return this.city=new AdminCity.Builder(this.city_data,this.map)},a.prototype.build_sell_locations=function(){var a,b,c,d;if(this.city_data.sell_locations.length>0){c=this.city_data.sell_locations,d=[];for(a in c)b=c[a],d.push(this.build_sell_location(b,a));return d}return this.build_sell_location()},a.prototype.build_sell_location=function(a){var b;return a==null&&(a=!1),b=new SellLocationsEditor.SellLocation(a,this.form_template,this.city,this.number++),b.append_to(this.container),this.sell_locations.push(b),this.bind_sell_location(b)},a.prototype.bind_sell_location=function(a){var b=this;return a.add_listener("enter",function(a){return b.build_sell_location(a)}),a.add_listener("remove",function(){return b.remove_sell_location(a)}),a.add_listener("focus",function(a){var c,d,e,f,g;f=b.sell_locations,g=[];for(d=0,e=f.length;d<e;d++)c=f[d],c===a?c.highlighted?g.push(void 0):g.push(c.highlight()):g.push(c.unhighlight());return g})},a.prototype.remove_sell_location=function(a){return this.sell_locations.splice(this.sell_locations.indexOf(a),1),a.remove()},a}()}.call(this),function(){var a=Object.prototype.hasOwnProperty,b=function(b,c){function e(){this.constructor=b}for(var d in c)a.call(c,d)&&(b[d]=c[d]);return e.prototype=c.prototype,b.prototype=new e,b.__super__=c.prototype,b};SellLocationsEditor.Marker=function(a){function c(a,b){this.gmap=a,this.latlng=b,this.add_to_map(),this.bind_marker()}return b(c,a),c.prototype.add_to_map=function(){return this.marker=new $G.Marker(this.options())},c.prototype.options=function(){return{map:this.gmap,draggable:!0,position:this.latlng,flat:!0,cursor:"default",icon:this.blue_icon(),raiseOnDrag:!1}},c.prototype.bind_marker=function(){var a=this;return $G.event.addListener(this.marker,"dragend",function(b){return a.fire_event("change",b.latLng)}),$G.event.addListener(this.marker,"click",function(){return a.fire_event("select")})},c.prototype.highlight=function(){return this.marker.setIcon(this.red_icon())},c.prototype.unhighlight=function(){return this.marker.setIcon(this.blue_icon())},c.prototype.hide=function(){return this.marker.setVisible(!1)},c.prototype.show=function(){return this.marker.setVisible(!0)},c.prototype.set_latlng=function(a){return this.latlng=a,this.marker.setPosition(this.latlng)},c.prototype.set_position=function(a){return this.latlng=a,this.set_latlng(this.latlng)},c.prototype.remove=function(){return this.marker.setMap(null)},c.prototype.red_icon=function(){var a;return(a=SellLocationsEditor.Marker).red_icon||(a.red_icon=new $G.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|FF0000",new $G.Size(21,34),new $G.Point(0,0),new $G.Point(10,34)))},c.prototype.blue_icon=function(){var a;return(a=SellLocationsEditor.Marker).blue_icon||(a.blue_icon=new $G.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|0000FF",new $G.Size(21,34),new $G.Point(0,0),new $G.Point(10,34)))},c}(Utils.Eventable)}.call(this),function(){var a=Object.prototype.hasOwnProperty,b=function(b,c){function e(){this.constructor=b}for(var d in c)a.call(c,d)&&(b[d]=c[d]);return e.prototype=c.prototype,b.prototype=new e,b.__super__=c.prototype,b};SellLocationsEditor.SellLocation=function(a){function c(a,b,c,d){this.template=b,this.city=c,this.number=d,this.highlighted=!1,this.data=_.extend({id:null,address:"",name:"",info:"",lat:0,lng:0,card_selling:null,card_reloading:null,ticket_selling:null,visibility:!0,inexact:!1,manual_position:!1},a),this.build_form_element(),this.bind_form_element(),this.create_marker()}return b(c,a),c.prototype.build_form_element=function(){return this.form_element=new SellLocationsEditor.FormElement(this.data,this.template,this.number)},c.prototype.bind_form_element=function(){var a=this;return this.inherit_listener(this.form_element,"remove"),this.form_element.add_listener("enter",function(b){return a.fire_event("enter",b)}),this.form_element.add_listener("focus",function(){return a.fire_event("focus",a)}),this.form_element.add_listener("address_change",function(){if(!a.form_element.data.manual_position)return a.fetch_address()})},c.prototype.create_marker=function(a){return a=new $G.LatLng(this.data.lat,this.data.lng),this.marker=new SellLocationsEditor.Marker(this.city.gmap,a),this.bind_marker()},c.prototype.bind_marker=function(){var a=this;return this.marker.add_listener("change",function(b){return a.update_from_dragging(b)}),this.marker.add_listener("select",function(){return console.log("click"),a.form_element.focus()})},c.prototype.append_to=function(a){return this.form_element.append_to(a)},c.prototype.remove=function(){return this.form_element.remove(),this.marker.remove()},c.prototype.highlight=function(){return this.highlighted=!0,this.marker.highlight()},c.prototype.unhighlight=function(){return this.highlighted=!1,this.marker.unhighlight()},c.prototype.fetch_address=function(){var a,b=this;return a=this.google_api_bug_workaround(this.form_element.address_val()),this.city.fetch_address(a,function(a,c){return b.update_from_fetching(a),b.update_marker(a)})},c.prototype.update_from_fetching=function(a){return this.update_form_latlng(a)},c.prototype.update_from_dragging=function(a){return this.form_element.set_manual_position(!0),this.update_form_latlng(a)},c.prototype.update_form_latlng=function(a){return this.form_element.set_latlng(a)},c.prototype.update_marker=function(a){return this.marker.set_latlng(a)},c.prototype.google_api_bug_workaround=function(a){var b,c,d;return d="+",b=a[a.length-1]===d,console.log(b),b&&(a=a.replace(/.$/,""),c=a.match(/[0-9]+[^0-9]*$/),c=parseInt(c),++c,a=a.replace(/[0-9]+[^0-9]*$/,c)),a},c}(Utils.Eventable)}.call(this);var SellLocationsReviews={};((function(){SellLocationsReviews.Builder=function(){function a(){this.build_map(),this.bind_map(),this.build_suggestions(),this.build_sell_location(),this.center_map()}return a.prototype.build_map=function(){return this.map_element=$("#map"),this.map_container=$("#map-container"),this.map=new MapTools.Map(this.map_element)},a.prototype.bind_map=function(){var a,b=this;return a=this.map_element.offset(),$(window).scroll(function(){var c;return c=$(window).scrollTop(),c>a.top?(b.map_element.css("position","fixed"),b.map_element.css("top",0),b.map_element.css("left",a.left)):(b.map_element.css("top",""),b.map_element.css("left",""),b.map_element.css("position","absolute"))})},a.prototype.build_sell_location=function(){return this.sell_location=new SellLocationsReviews.SellLocation(this.map.gmap)},a.prototype.center_map=function(){return this.map.set_center(this.sell_location.get_position())},a.prototype.build_suggestions=function(){var a=this;return this.suggestions_elements=$("#suggestions fieldset"),this.suggestions=[],this.suggestions_elements.each(function(b,c){var d;return d=new SellLocationsReviews.Suggestion($(c),a.map.gmap),a.bind_suggestion(d),a.suggestions.push(d)})},a.prototype.bind_suggestion=function(a){var b=this;return a.add_listener("select",function(a,c){return b.sell_location.set_val(a,c)}),a.add_listener("hover",function(){var c,d,e,f;f=b.suggestions;for(d=0,e=f.length;d<e;d++)c=f[d],c!==a&&c.unhighlight();return a.highlight()})},a}()})).call(this),function(){var a=Object.prototype.hasOwnProperty,b=function(b,c){function e(){this.constructor=b}for(var d in c)a.call(c,d)&&(b[d]=c[d]);return e.prototype=c.prototype,b.prototype=new e,b.__super__=c.prototype,b};SellLocationsReviews.Form=function(a){function c(){this.find_elements()}return b(c,a),c.prototype.find_elements=function(){return this.element=$("form"),this.container=$("#sell-location"),this.inputs={}},c.prototype.set_position=function(a){return this.set_val("lat",a.lat()),this.set_val("lng",a.lng()),this.set_val("manual_position",!0)},c.prototype.get_position=function(){return $LatLng([parseFloat(this.get_val("lat")),parseFloat(this.get_val("lng"))])},c.prototype.val=function(a,b){return b===void 0?this.get_val(a):this.set_val(a,b)},c.prototype.set_val=function(a,b){var c;return c=this.find_input(a),c.val(b)},c.prototype.get_val=function(a){var b;return b=this.find_input(a),b.val()},c.prototype.find_input=function(a){var b;return this.inputs[a]?this.inputs[a]:(b=this.container.find("[name*='"+a+"']"),this.inputs[a]=new Utils.Input(b))},c}(Utils.Eventable),Utils.Input=function(){function a(a){this.element=a,this.element=this.element.last(),this.set_type()}return a.prototype.set_type=function(){var a;return a=this.element.prop("tagName"),a==="INPUT"?this.type=this.element.attr("type"):this.type=a.toLowerCase()},a.prototype.val=function(a){return a!==void 0?this.set_val(a):this.get_val()},a.prototype.set_val=function(a){return this.type==="checkbox"?this.element.prop("checked",a):this.type==="select"?this.element.val(this.to_select(a)):this.element.val(a)},a.prototype.get_val=function(){return this.type==="checkbox"?this.element.is(":checked"):this.type==="select"?this.from_select(this.element.val()):this.element.val()},a.prototype.to_select=function(a){return a===!0?"true":a===!1?"false":a},a.prototype.from_select=function(a){return a==="true"?!0:a==="false"?!1:a},a}()}.call(this),function(){$(function(){if($(document.body).is(".edit.admin_sell_locations"))return new SellLocationsReviews.Builder})}.call(this),function(){var a=Object.prototype.hasOwnProperty,b=function(b,c){function e(){this.constructor=b}for(var d in c)a.call(c,d)&&(b[d]=c[d]);return e.prototype=c.prototype,b.prototype=new e,b.__super__=c.prototype,b};SellLocationsReviews.Marker=function(a){function c(){c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.draggable=function(a){return this.marker.setDraggable(a)},c.prototype.green=function(){return this.marker.setIcon(this.green_icon())},c.prototype.green_icon=function(){var a;return(a=SellLocationsReviews.Marker).green_icon||(a.green_icon=new $G.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|00FF00",new $G.Size(21,34),new $G.Point(0,0),new $G.Point(10,34)))},c}(SellLocationsEditor.Marker)}.call(this),function(){SellLocationsReviews.SellLocation=function(){function a(a){this.gmap=a,this.build_form(),this.build_marker(),this.bind_marker()}return a.prototype.build_form=function(){return this.form=new SellLocationsReviews.Form},a.prototype.build_marker=function(){return this.marker=new SellLocationsReviews.Marker(this.gmap,this.form.get_position()),this.marker.green()},a.prototype.bind_marker=function(){var a=this;return this.marker.add_listener("change",function(b){return a.form.set_position(b)})},a.prototype.get_position=function(){return this.form.get_position()},a.prototype.set_position=function(a){return this.form.set_position(a)},a.prototype.update_marker_position=function(){return this.marker.set_position(this.form.get_position())},a.prototype.set_val=function(a,b){this.form.set_val(a,b);if(a==="lat"||a==="lng")return this.form.val("manual_position",!0),this.update_marker_position()},a}()}.call(this),function(){var a=Object.prototype.hasOwnProperty,b=function(b,c){function e(){this.constructor=b}for(var d in c)a.call(c,d)&&(b[d]=c[d]);return e.prototype=c.prototype,b.prototype=new e,b.__super__=c.prototype,b};SellLocationsReviews.Suggestion=function(a){function c(a,b){this.form_element=a,this.gmap=b,this.build_form(),this.bind_form(),this.build_marker(),this.hidden=!1}return b(c,a),c.prototype.build_form=function(){return this.form=new SellLocationsReviews.SuggestionForm(this.form_element)},c.prototype.bind_form=function(){var a=this;return this.form.add_listener("close",function(){a.form.hide();if(a.marker)return a.marker.hide()}),this.form.add_listener("select",function(b,c){return a.fire_event("select",b,c)}),this.inherit_listener(this.form,"hover"),this.form.add_listener("toggle",function(){return a.hidden?a.show():a.hide()})},c.prototype.hide=function(){this.hidden=!0,this.form.hide();if(this.marker)return this.marker.hide()},c.prototype.show=function(){this.hidden=!1,this.form.show();if(this.marker)return this.marker.show()},c.prototype.build_marker=function(){var a;return a=this.form.get_position(),a?(this.marker=new SellLocationsReviews.Marker(this.gmap,a),this.marker.draggable(!1)):this.marker=null},c.prototype.unhighlight=function(){if(this.marker)return this.marker.unhighlight()},c.prototype.highlight=function(){if(this.marker)return this.marker.highlight()},c}(Utils.Eventable)}.call(this),function(){var a=Object.prototype.hasOwnProperty,b=function(b,c){function e(){this.constructor=b}for(var d in c)a.call(c,d)&&(b[d]=c[d]);return e.prototype=c.prototype,b.prototype=new e,b.__super__=c.prototype,b};SellLocationsReviews.SuggestionForm=function(a){function c(a){this.element=a,this.find_elements(),this.bind_elements()}return b(c,a),c.prototype.find_elements=function(){return this.selectable_values=this.element.find(".selectable-values"),this.values=this.selectable_values.find("li"),this.reviewed_checkbox=this.element.find('[name*="reviewed"]'),this.position_element=this.values.filter(".position"),this.title_element=this.element.find(".user-info")},c.prototype.bind_elements=function(){var a=this;return this.values.click(function(b){var c,d,e,f,g,h;return c=$(b.currentTarget),f=c.attr("class"),g=c.find(".value").text(),f==="position"?(h=g.split(","),d=h[0],e=h[1],d=parseFloat(d),e=parseFloat(e),a.send_value("lat",d),a.send_value("lng",e)):(g==="true"&&(g=!0),g==="false"&&(g=!1),a.send_value(f,g))}),this.reviewed_checkbox.change(function(b){if(a.reviewed_checkbox.is(":checked"))return a.fire_event("close")}),this.element.mouseover(function(){return a.fire_event("hover")}),this.title_element.click(function(){return a.fire_event("toggle")})},c.prototype.get_position=function(){var a,b,c,d,e;a=this.position_element.find(".value");if(a.length>0)return d=this.position_element.find(".value").text(),e=d.split(","),b=e[0],c=e[1],b=parseFloat(b),c=parseFloat(c),$LatLng([b,c])},c.prototype.hide=function(){return this.element.addClass("minimized")},c.prototype.show=function(){return this.element.removeClass("minimized")},c.prototype.send_value=function(a,b){return this.fire_event("select",a,b)},c}(Utils.Eventable)}.call(this),!0;